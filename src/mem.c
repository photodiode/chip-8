
#include <stdio.h>
#include <stdlib.h>

#include <stdint.h>
#include <string.h>

#include <pthread.h>

uint8_t         mem[4096];
pthread_mutex_t mem_lock = PTHREAD_MUTEX_INITIALIZER;

const size_t  font_len = 80;
const uint8_t font[] = {
	0xF0, 0x90, 0x90, 0x90, 0xF0, //0
	0x20, 0x60, 0x20, 0x20, 0x20, //1
	0xF0, 0x10, 0xF0, 0x80, 0xF0, //2
	0xF0, 0x10, 0x70, 0x10, 0xF0, //3
	0x30, 0x50, 0x90, 0xF0, 0x10, //4
	0xF0, 0x80, 0xF0, 0x10, 0xF0, //5
	0xF0, 0x80, 0xF0, 0x90, 0xF0, //6
	0xF0, 0x10, 0x20, 0x40, 0x40, //7
	0xF0, 0x90, 0xF0, 0x90, 0xF0, //8
	0xF0, 0x90, 0xF0, 0x10, 0xF0, //9
	0x60, 0x90, 0x90, 0xF0, 0x90, //A
	0xE0, 0x90, 0xE0, 0x90, 0xF0, //B
	0x70, 0x80, 0x80, 0x80, 0x70, //C
	0xE0, 0x90, 0x90, 0x90, 0xE0, //D
	0xF0, 0x80, 0xE0, 0x80, 0xF0, //E
	0xF0, 0x80, 0xE0, 0x80, 0x80  //F
};

void mem_initialize() {

	// load font
	memcpy(&mem[0x000], font, font_len);

}

void mem_load_program(const char* filename) {

	FILE *file_ptr = fopen(filename, "rb");
	if (!file_ptr) {
		printf("CHIP-8: Couldn't open '%s'\n", filename);
		exit(EXIT_FAILURE);
	}

	fseek(file_ptr, 0, SEEK_END);
	const size_t file_size = ftell(file_ptr);
	fseek(file_ptr, 0, SEEK_SET);
	
	if (file_size >= 0xCA0) {
		printf("CHIP-8: Program '%s' is too big\n", filename);
		exit(EXIT_FAILURE);
	}

	pthread_mutex_lock(&mem_lock);
	fread(&mem[0x200], 1, file_size, file_ptr);
	pthread_mutex_unlock(&mem_lock);

	fclose(file_ptr);

	return;
}
